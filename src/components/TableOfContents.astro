---
// TableOfContents component - Notion-style TOC for blog posts
---

<aside
  id="table-of-contents"
  class="fixed top-[120px] right-[max(0px,calc((100vw-1280px)/2))] w-60 max-h-[calc(100vh-160px)] overflow-y-auto px-6 hidden xl:block toc-scrollbar"
>
  <nav class="sticky top-0">
    <ul id="toc-list" class="list-none p-0 m-0"></ul>
  </nav>
</aside>

<script>
  // TOC 생성 및 관리
  function initTableOfContents() {
    const article = document.querySelector('article');
    const tocList = document.getElementById('toc-list');

    if (!article || !tocList) return;

    // h1, h2, h3 헤딩 요소 찾기
    const headings = article.querySelectorAll(
      'h1, h2, h3',
    ) as NodeListOf<HTMLElement>;

    if (headings.length === 0) {
      // 헤딩이 없으면 TOC 숨기기
      const tocContainer = document.getElementById('table-of-contents');
      if (tocContainer) tocContainer.style.display = 'none';
      return;
    }

    // TOC 아이템 생성
    headings.forEach((heading, index) => {
      const headingElement = heading as HTMLElement;

      // 헤딩에 ID 추가 (없는 경우)
      if (!headingElement.id) {
        headingElement.id = `heading-${index}`;
      }

      const level = headingElement.tagName.toLowerCase();
      const text = headingElement.textContent || '';

      const li = document.createElement('li');
      li.className = `toc-item toc-${level}`;

      const a = document.createElement('a');
      a.href = `#${headingElement.id}`;
      a.textContent = text;

      // Tailwind 클래스 설정 (디자인 토큰 사용)
      const baseClasses =
        'block py-0 pl-4 text-sm leading-6 no-underline transition-colors duration-150';
      const levelClasses = {
        h1: 'font-semibold pl-4',
        h2: 'pl-6',
        h3: 'pl-8 text-[0.8125rem]',
      };

      // 기본 스타일 적용 (더 연한 색상)
      a.style.color = 'var(--color-text-tertiary)';
      a.className = `${baseClasses} ${levelClasses[level as keyof typeof levelClasses] || ''}`;

      // 호버 시 색상만 진하게 (active 상태가 아닐 때만)
      a.addEventListener('mouseenter', () => {
        if (!a.classList.contains('active')) {
          a.style.color = 'var(--color-text-secondary)';
        }
      });
      a.addEventListener('mouseleave', () => {
        if (!a.classList.contains('active')) {
          a.style.color = 'var(--color-text-tertiary)';
        }
      });

      // 클릭 시 부드러운 스크롤
      a.addEventListener('click', (e) => {
        e.preventDefault();
        headingElement.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // URL 업데이트
        history.pushState(null, '', `#${headingElement.id}`);
      });

      li.appendChild(a);
      tocList.appendChild(li);
    });

    // 스크롤 시 활성 섹션 하이라이트
    let ticking = false;

    function updateActiveSection() {
      const scrollPosition = window.scrollY + 100; // 오프셋

      let currentHeading: HTMLElement | null = null;
      Array.from(headings).forEach((heading) => {
        const headingElement = heading as HTMLElement;
        const top = headingElement.offsetTop;
        if (scrollPosition >= top) {
          currentHeading = headingElement;
        }
      });

      // 모든 링크에서 active 클래스 제거 및 기본 색상 복원
      document.querySelectorAll('a[href^="#"]').forEach((link) => {
        if (link instanceof HTMLElement) {
          link.classList.remove('active');
          link.style.color = 'var(--color-text-tertiary)';
        }
      });

      // 현재 섹션 링크에 active 클래스 추가 (색상만 변경, 크기 변경 없음)
      if (currentHeading) {
        const headingId = (currentHeading as HTMLElement).id;
        if (headingId) {
          const activeLink = document.querySelector(
            `a[href="#${headingId}"]`,
          ) as HTMLElement | null;
          if (activeLink) {
            activeLink.classList.add('active');
            activeLink.style.color = 'var(--color-link)';
          }
        }
      }

      ticking = false;
    }

    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateActiveSection();
        });
        ticking = true;
      }
    });

    // 초기 활성 섹션 설정
    updateActiveSection();
  }

  // DOM 로드 후 초기화
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTableOfContents);
  } else {
    initTableOfContents();
  }
</script>

<style>
  /* 스크롤바 스타일링 (디자인 토큰 사용) */
  .toc-scrollbar::-webkit-scrollbar {
    width: 4px;
  }

  .toc-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }

  .toc-scrollbar::-webkit-scrollbar-thumb {
    background: var(--color-border-primary);
    border-radius: 2px;
  }

  .toc-scrollbar::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-tertiary);
  }
</style>
